<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DÄ«Ä·a hokeja lÄ«ga</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; max-width: 1100px; }
    h1 { margin: 0 0 10px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    label { display:block; font-size: 12px; opacity: .8; margin-bottom: 4px; }
    input, select, button, textarea { padding: 8px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor:pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    th { position: sticky; top: 0; background: #fff; }
    .muted { opacity: .7; font-size: 12px; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .danger { border-color: #ffb3b3; background:#fff5f5; }
  </style>
</head>
<body>
  <h1>ğŸ’ DÄ«Ä·a hokeja lÄ«ga</h1>
  <div class="muted">Viss glabÄjas tavÄ pÄrlÅ«kÄ (LocalStorage). Vari eksportÄ“t/importÄ“t sezonu JSON failÄ.</div>

  <div class="card">
    <h2>1) SpÄ“lÄ“tÄji</h2>
    <div class="row">
      <div>
        <label>Jauns spÄ“lÄ“tÄjs</label>
        <input id="playerName" placeholder="piem. JÄnis" />
      </div>
      <button id="addPlayer">Pievienot</button>
      <button id="reset" class="danger">NotÄ«rÄ«t visu sezonu</button>
    </div>
    <div class="muted" style="margin-top:6px;">Tip: vari pievienot ~30 spÄ“lÄ“tÄjus un viss strÄdÄs.</div>
    <div id="playerList" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h2>2) PierakstÄ«t maÄu</h2>
    <div class="row">
      <div>
        <label>A komanda (3)</label>
        <select id="a1"></select>
        <select id="a2"></select>
        <select id="a3"></select>
      </div>
      <div>
        <label>B komanda (3)</label>
        <select id="b1"></select>
        <select id="b2"></select>
        <select id="b3"></select>
      </div>
      <div>
        <label>C komanda (3)</label>
        <select id="c1"></select>
        <select id="c2"></select>
        <select id="c3"></select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>UzvarÄ“tÄjs</label>
        <select id="winner">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>

      <div>
        <label>RezultÄts (pÄ“c izvÄ“les)</label>
        <input id="score" placeholder="piem. A 3-1 B-? C-? vai 3-2-1" />
      </div>

      <div>
        <label>PiezÄ«mes (pÄ“c izvÄ“les)</label>
        <input id="notes" placeholder="piem. G/A: JÄnis 2+1; MÄris 1+0" style="min-width:320px;" />
      </div>

      <button id="addMatch">Pievienot maÄu</button>
    </div>

    <div class="muted" style="margin-top:6px;">
      Noteikums: visi 9 spÄ“lÄ“tÄji saÅ†em â€œmaÄs +1â€. UzvarÄ“tÄju komandai â€œuzvara +1â€.
      Goals/assist vari rakstÄ«t piezÄ«mÄ“s (vai mÄ“s varam uztaisÄ«t atseviÅ¡Ä·u G/A formu).
    </div>
  </div>

  <div class="card">
    <h2>3) Tabula</h2>
    <div class="row">
      <button id="exportBtn">EksportÄ“t JSON</button>
      <label class="pill">
        ImportÄ“t JSON <input id="importFile" type="file" accept="application/json" style="display:none;">
      </label>
      <span class="muted">Reitings: vienkÄrÅ¡i Win% (uzvaras / maÄi). Varam ielikt ELO, ja gribi.</span>
    </div>
    <div style="overflow:auto; max-height: 420px; margin-top:10px;">
      <table id="table">
        <thead>
          <tr>
            <th>#</th>
            <th>SpÄ“lÄ“tÄjs</th>
            <th>MaÄi</th>
            <th>Uzvaras</th>
            <th>Win%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>4) MaÄu vÄ“sture</h2>
    <div class="muted">PÄ“dÄ“jie 50.</div>
    <div id="matches" style="margin-top:10px;"></div>
  </div>

<script>
  const KEY = "dika_hokeja_liga_v1";

  const state = load() || {
    players: [],   // {id, name, games, wins}
    matches: []    // {ts, A:[ids], B:[ids], C:[ids], winner, score, notes}
  };

  function uid() { return Math.random().toString(36).slice(2,10); }
  function save() { localStorage.setItem(KEY, JSON.stringify(state)); }
  function load() { try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }

  const el = (id) => document.getElementById(id);

  function renderPlayers() {
    const list = state.players.map(p =>
      `<span class="pill">${escapeHtml(p.name)} <button data-del="${p.id}" title="DzÄ“st" style="margin-left:6px;">Ã—</button></span>`
    ).join(" ");
    el("playerList").innerHTML = list || `<span class="muted">Nav spÄ“lÄ“tÄju. Pievieno pirmos!</span>`;

    // Fill selects
    const selects = ["a1","a2","a3","b1","b2","b3","c1","c2","c3"].map(el);
    selects.forEach(s => {
      const current = s.value;
      s.innerHTML = `<option value="">â€”</option>` + state.players
        .map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
      if (state.players.some(p => p.id === current)) s.value = current;
    });
  }

  function renderTable() {
    const sorted = [...state.players].sort((p,q) => {
      const wp = p.games ? p.wins/p.games : 0;
      const wq = q.games ? q.wins/q.games : 0;
      if (wq !== wp) return wq - wp;
      if (q.wins !== p.wins) return q.wins - p.wins;
      return q.games - p.games;
    });

    const rows = sorted.map((p,i) => {
      const wp = p.games ? (100*p.wins/p.games) : 0;
      return `<tr>
        <td>${i+1}</td>
        <td>${escapeHtml(p.name)}</td>
        <td>${p.games}</td>
        <td>${p.wins}</td>
        <td>${wp.toFixed(1)}%</td>
      </tr>`;
    }).join("");
    el("table").querySelector("tbody").innerHTML = rows || `<tr><td colspan="5" class="muted">Nav datu.</td></tr>`;
  }

  function renderMatches() {
    const last = [...state.matches].slice(-50).reverse();
    const nameOf = (id) => state.players.find(p => p.id===id)?.name || "??";
    el("matches").innerHTML = last.map(m => {
      const A = m.A.map(nameOf).join(", ");
      const B = m.B.map(nameOf).join(", ");
      const C = m.C.map(nameOf).join(", ");
      const d = new Date(m.ts).toLocaleString();
      return `<div class="card" style="margin:8px 0;">
        <div><b>${d}</b> Â· Uzvar: <span class="pill">${m.winner}</span> ${m.score ? `Â· <span class="pill">${escapeHtml(m.score)}</span>` : ""}</div>
        <div class="muted">A: ${escapeHtml(A)}<br/>B: ${escapeHtml(B)}<br/>C: ${escapeHtml(C)}</div>
        ${m.notes ? `<div style="margin-top:6px;">ğŸ“ ${escapeHtml(m.notes)}</div>` : ""}
      </div>`;
    }).join("") || `<span class="muted">Nav maÄu.</span>`;
  }

  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function addPlayer(name) {
    name = (name||"").trim();
    if (!name) return;
    if (state.players.some(p => p.name.toLowerCase() === name.toLowerCase())) return alert("Å Äds spÄ“lÄ“tÄjs jau ir.");
    state.players.push({ id: uid(), name, games: 0, wins: 0 });
    save(); renderAll();
  }

  function deletePlayer(id) {
    // Only allow if player not used in matches (simple safety)
    if (state.matches.some(m => [...m.A,...m.B,...m.C].includes(id))) {
      return alert("Nevar dzÄ“st: spÄ“lÄ“tÄjs jau ir maÄu vÄ“sturÄ“. (Varu uztaisÄ«t funkciju 'arhivÄ“t'.)");
    }
    state.players = state.players.filter(p => p.id !== id);
    save(); renderAll();
  }

  function parseTeams() {
    const ids = ["a1","a2","a3","b1","b2","b3","c1","c2","c3"].map(id => el(id).value);
    const all = ids.filter(Boolean);
    if (all.length !== 9) throw new Error("IzvÄ“lies 9 spÄ“lÄ“tÄjus (3 katrai komandai).");
    const uniq = new Set(all);
    if (uniq.size !== 9) throw new Error("Nevar bÅ«t viens un tas pats spÄ“lÄ“tÄjs vairÄkÄs vietÄs.");
    return {
      A: [el("a1").value, el("a2").value, el("a3").value],
      B: [el("b1").value, el("b2").value, el("b3").value],
      C: [el("c1").value, el("c2").value, el("c3").value]
    };
  }

  function addMatch() {
    const teams = parseTeams();
    const winner = el("winner").value;
    const score = el("score").value.trim();
    const notes = el("notes").value.trim();

    const match = { ts: Date.now(), ...teams, winner, score, notes };
    state.matches.push(match);

    // update players stats
    const winners = match[winner];
    const participants = [...match.A, ...match.B, ...match.C];
    participants.forEach(id => {
      const p = state.players.find(x => x.id === id);
      if (p) p.games += 1;
    });
    winners.forEach(id => {
      const p = state.players.find(x => x.id === id);
      if (p) p.wins += 1;
    });

    el("score").value = "";
    el("notes").value = "";
    save(); renderAll();
  }

  function resetAll() {
    if (!confirm("TieÅ¡Äm notÄ«rÄ«t visu sezonu?")) return;
    localStorage.removeItem(KEY);
    location.reload();
  }

  function exportJSON() {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dika-hokeja-sezona.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJSON(file) {
    const r = new FileReader();
    r.onload = () => {
      try {
        const obj = JSON.parse(r.result);
        if (!obj.players || !obj.matches) throw new Error("Nepareizs fails.");
        localStorage.setItem(KEY, JSON.stringify(obj));
        location.reload();
      } catch(e) {
        alert("Importa kÄ¼Å«da: " + e.message);
      }
    };
    r.readAsText(file);
  }

  function renderAll() {
    renderPlayers();
    renderTable();
    renderMatches();
  }

  // events
  el("addPlayer").onclick = () => { addPlayer(el("playerName").value); el("playerName").value=""; el("playerName").focus(); };
  el("playerName").addEventListener("keydown", (e) => { if (e.key === "Enter") el("addPlayer").click(); });

  document.body.addEventListener("click", (e) => {
    const id = e.target?.getAttribute?.("data-del");
    if (id) deletePlayer(id);
  });

  el("addMatch").onclick = () => {
    try { addMatch(); }
    catch(e) { alert(e.message); }
  };

  el("reset").onclick = resetAll;
  el("exportBtn").onclick = exportJSON;
  el("importFile").onchange = (e) => { if (e.target.files?.[0]) importJSON(e.target.files[0]); };

  renderAll();
</script>
</body>
</html>
